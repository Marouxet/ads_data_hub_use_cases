/*

Path to conversion - Deduplicated analysis


DATA FROM: CAMPAING MANAGER
Filters:
advertiserId = 8136487
activity_id IN (6782320)

Parameter
@lookback_window = 30


NAME OF THE TABLE:
NOTE: naming convention: <name-initials><use-case-name>_<query-version>_<startdate>_<enddate>_<runversion>

*/
WITH
  path_to_conversion AS (
    WITH
        conversions AS (
            SELECT
                user_id,
                event.event_time,
                event.activity_id,
                ROW_NUMBER() OVER (PARTITION BY user_id ORDER BY event.event_time ) AS cnv_id
            FROM `adh.cm_dt_activities_attributed`
            WHERE user_id != '0'
            AND event.advertiser_id = 8136487 
            AND event.activity_id IN (6782320)
            AND EXTRACT(DATE FROM TIMESTAMP_MICROS(event.event_time) AT TIME ZONE "America/Los_Angeles") >= DATE_ADD(@start_date, INTERVAL @lookback_window DAY)
            
        ),
        events AS (
            SELECT
                imp.user_id,
                imp.event.event_time,
                imp.event.advertiser_id,
                imp.event.placement_id,
                "imp" AS event_type
            FROM `adh.cm_dt_impressions` AS imp
            WHERE user_id != '0'
            AND event.advertiser_id = 8136487
            AND imp.event.placement_id IN(
                254411042,259702611,238331303,241818948,266044619,271292767,272401082,273597388,288423978,280206774,282287145,311361486,305471806,299061052,307709662,307482773,306522556,307705018,307482542,306317883,308922553,323469015,323469717,322016160,316224973,316244773,316060487,327578986,326369840,299072005,298833611,298935888,298936431,298935891,299071999,298935885,321452976,321411719,307529085,316471317,316470231,316471068,316470225,316350237,316468941,316468947,316471062,316482023,316470237,316471059,316553086,316470837,316470519,299074105,299074510,299074507,299074516,299074102,299074504,299074513,317481016,317277101,317276514,317481022,317480692,325620001,325620004,325620010,325620007,325620013,325620016,325620019,325423242,325384304,325617961,325618474,325618477,325617967,325617973,336042486,336203260,336042549,335919317,335918249,335918474,335919374,325385591,325385594,325385597,325385600,325385603,325385606,325385609,325384358,325384361,325384364,325384367,325384370,325384373,325384376,325620061,325620064,325620067,325620070,325620073,325620076,325620079,311272200,335225250,311272458,335225253,311272197,335225256,311272449,335225259,311421187,335225262,311272461,335225265,311272455,335225268,325385495,325385498,325385501,325385504,325385507,325385510,325385513,339547979,332657005,332657785,311421190,311272206,311272209,311272212,311421193,311421196,311272464,325617526,325617529,325617532,325617535,325617538,325617541,325622344,325620145,325620148,325620151,325620154,325620157,325620160,325620163,333086368,333090088,333086380,333091783,333091795,333092098,333007833,337797530,337938255,337797545,337783421,337797554,337938279,337946505,317627842,317627845,317417840,317627296,317627839,317422260,317627293,317423592,317425416,317627287,317627836,317423589,317425152,317425155,317627281,317627284,317417837,317627830,317423586,317423583,317627833,317417846,317425422,317422269,317425158,317425419,317425161,317627851,325617901,325617907,325617910,325385456,325385450,325423239,325385453,316909111,316697885,316699226,316699229,316698725,316698449,316697618,325617403,325617406,325617409,325617412,325617415,325617418,325617421,316697888,316698731,316697894,316699421,316698734,316697891,316697900,311336242,311335972,311336245,311197095,311196723,311335762,311335975,311196705,311111327,311196702,311112119,311336224,311336227,311335741,311335960,311196714,311335750,311198619,311335753,311111333,311335963,311336221,311196699,311335732,311335735,311197083,311196696,311335738,311196708,311111330,311196711,311112158,311335747,311335744,311198583,311198754,311196726,311197098,311197101,311111348,311198742,311335765,311111336,311335969,311196717,311336233,311197089,311335756,311335966,309499086,309673288,309501018,309497577,309670915,309500802,309401273,310149127,310149130,309918030,316126750,316126741,316126747,316126744,315949275,315951039,316125094,315949278,316125097,315951375,340862340,340869618,340713344,340866675,340990975,340866681,340869630,315807114,315808365,315980161,315980170,315980164,315807807,315808362,299059237,298818551,298817564,298818545,299059231,299057224,299057836,341005199,307435493,299057890,315796014,299042413,299057923,298915524,299057965,298915536,299057317,298915500,299059384,298913898,315789864,299056519,315789861,299056795,315965791,299056798,315789867,298818524,315789873,298914108,298817984,299057962,299059393,298915527,332429143,307688617,307688620,323120018,316824442,318069449,318069446,316074839,316624094,316685492,316824439,315965170,315792851,315792857,316470219,315965164,315789693,315789876,315965797,315965779,315789855,315791834,315792854,316482014,315791825,315787902,315791849,315965776,315791828,315791822,315789705,315965167,315789870,315792164,315789879,316471026,315789696,315787914,315789852,315965788,315965782,315787905,315789690,315792161,330173174,330185934,330173183,330196569,330191166,330191526,330185943,339538184,245606684,246423569,341345693,341361809,341811987,301126951,301125868,301127413,316679467,316677544,334573477,334352834,334664501,334664504,334573474,334356959,334448268,334448274,298993016,299235565,299230648,299007293,315881638,299274279,315720857,333512219,333611970,333517061,333517064,333513665,333513662,333512219,333611970,334357175,333514124,333974197,333974200,333974164,333972886,317169401,317169101,317169104,315881629,315883102,299113320,299008277,299243536,333845658,333845661,333974197,333974200,333729869,333729872,333974164,333972886,280783524,335453432,241992493,242196987,224063281,241890188,254141473,316754573,241998244,229805586,243658881,315227666,320163566,315229370,315209658,315209649,314882338,315190776,315195378,315190779,315205469,315360490,315360487,315195375,315205466,320375557,320375560,306960549,312278613,315205394,315210806,315190470,269309104,315190701,315360562,315362545,315190752,272217475,272217475,322260906,316731180,316717049,295491829,315190749,321034528,326792568,327862644,339888752,339888770,340021914,339888761,340006020,340867441,340170508,340174306,340170544,340172041,326778558,326853353,340181785,340181818,339889046,339898976,340029410,340318301,340174291,340170541,297027005,288948342,288948357,288948339,288948354,291970551,291970548,291970545,291970542,291970539,298660362,298580117,298580312,298580342,288948336,288948351,293239917,293239938,293239929,293239923,293239935,293239920,293239944,293239932,293239926,293239941,291480310,288948333,288948348,288948330,288948345,279992129,298945896,299082016,298945011,298945893,298844939,298844930,299081986,299082508,298844942,299082007,298945899,299082010,299082004,299081983,298844927,299081980,321570784,321570061,321423396,321568363,321423390,321568360,321423939,321423933,321570781,321423393,315810434,315810431,298944990,298844924,299081977,299082487,298946175,299082139,299082001,298944999,315979669,315806511,298844915,299082127,299082502,298844921,298946181,299081995,299081992,298946172,331201983,331153586,331133072,331143770,331154798,331143800,331154291,331227135,331152677,331155194,331155113,331152587,331326763,331224594,331326778,331201965,332791593,332707400,332790114,332713616,331155809,331230849,331230453,331232319,337690161,337664874,337831555,337690191,337527356,337664862,337690185,337831561,337831519,337690173,337831546,337557107,337527389,337664877,337664883,337690194,337527365,337690179,337831552,337664892,337673820,337690176,337831549,337547300,333998505,334124077,333997707,333997710,337551371,337690419,337557359,337547483,337551374,337551377,337567661,337567673,337567664,337567670,337690416,337690425,337704003,337557362,337563299,337567691,298915449,298819160,299082073,298946103,299406979,299081959,299082070,299082454,299406982,298945866,299175368,299081923,299082421,299082049,299272104,298946109,299082448,299082052,298945869,299082445,298946127,298944948,299082451,298944204,299082058,302458981,302458984,299081920,299081926,298946112,298944930,299082055,298944183,330197105,330197165,299102536,315979666,315979663,298967727,299102533,315979960,315979519,298967091,315809837,315979948,315806508,307695667,308362233,308364228,308362224,328477487,328499136            
                )
            UNION ALL
            SELECT
                clk.user_id,
                clk.event.event_time,
                clk.event.advertiser_id,
                clk.event.placement_id,
                "clk" AS event_type
            FROM `adh.cm_dt_clicks` AS clk
            WHERE user_id != '0'
            AND event.advertiser_id = 8136487 
            AND clk.event.placement_id IN(
                254411042,259702611,238331303,241818948,266044619,271292767,272401082,273597388,288423978,280206774,282287145,311361486,305471806,299061052,307709662,307482773,306522556,307705018,307482542,306317883,308922553,323469015,323469717,322016160,316224973,316244773,316060487,327578986,326369840,299072005,298833611,298935888,298936431,298935891,299071999,298935885,321452976,321411719,307529085,316471317,316470231,316471068,316470225,316350237,316468941,316468947,316471062,316482023,316470237,316471059,316553086,316470837,316470519,299074105,299074510,299074507,299074516,299074102,299074504,299074513,317481016,317277101,317276514,317481022,317480692,325620001,325620004,325620010,325620007,325620013,325620016,325620019,325423242,325384304,325617961,325618474,325618477,325617967,325617973,336042486,336203260,336042549,335919317,335918249,335918474,335919374,325385591,325385594,325385597,325385600,325385603,325385606,325385609,325384358,325384361,325384364,325384367,325384370,325384373,325384376,325620061,325620064,325620067,325620070,325620073,325620076,325620079,311272200,335225250,311272458,335225253,311272197,335225256,311272449,335225259,311421187,335225262,311272461,335225265,311272455,335225268,325385495,325385498,325385501,325385504,325385507,325385510,325385513,339547979,332657005,332657785,311421190,311272206,311272209,311272212,311421193,311421196,311272464,325617526,325617529,325617532,325617535,325617538,325617541,325622344,325620145,325620148,325620151,325620154,325620157,325620160,325620163,333086368,333090088,333086380,333091783,333091795,333092098,333007833,337797530,337938255,337797545,337783421,337797554,337938279,337946505,317627842,317627845,317417840,317627296,317627839,317422260,317627293,317423592,317425416,317627287,317627836,317423589,317425152,317425155,317627281,317627284,317417837,317627830,317423586,317423583,317627833,317417846,317425422,317422269,317425158,317425419,317425161,317627851,325617901,325617907,325617910,325385456,325385450,325423239,325385453,316909111,316697885,316699226,316699229,316698725,316698449,316697618,325617403,325617406,325617409,325617412,325617415,325617418,325617421,316697888,316698731,316697894,316699421,316698734,316697891,316697900,311336242,311335972,311336245,311197095,311196723,311335762,311335975,311196705,311111327,311196702,311112119,311336224,311336227,311335741,311335960,311196714,311335750,311198619,311335753,311111333,311335963,311336221,311196699,311335732,311335735,311197083,311196696,311335738,311196708,311111330,311196711,311112158,311335747,311335744,311198583,311198754,311196726,311197098,311197101,311111348,311198742,311335765,311111336,311335969,311196717,311336233,311197089,311335756,311335966,309499086,309673288,309501018,309497577,309670915,309500802,309401273,310149127,310149130,309918030,316126750,316126741,316126747,316126744,315949275,315951039,316125094,315949278,316125097,315951375,340862340,340869618,340713344,340866675,340990975,340866681,340869630,315807114,315808365,315980161,315980170,315980164,315807807,315808362,299059237,298818551,298817564,298818545,299059231,299057224,299057836,341005199,307435493,299057890,315796014,299042413,299057923,298915524,299057965,298915536,299057317,298915500,299059384,298913898,315789864,299056519,315789861,299056795,315965791,299056798,315789867,298818524,315789873,298914108,298817984,299057962,299059393,298915527,332429143,307688617,307688620,323120018,316824442,318069449,318069446,316074839,316624094,316685492,316824439,315965170,315792851,315792857,316470219,315965164,315789693,315789876,315965797,315965779,315789855,315791834,315792854,316482014,315791825,315787902,315791849,315965776,315791828,315791822,315789705,315965167,315789870,315792164,315789879,316471026,315789696,315787914,315789852,315965788,315965782,315787905,315789690,315792161,330173174,330185934,330173183,330196569,330191166,330191526,330185943,339538184,245606684,246423569,341345693,341361809,341811987,301126951,301125868,301127413,316679467,316677544,334573477,334352834,334664501,334664504,334573474,334356959,334448268,334448274,298993016,299235565,299230648,299007293,315881638,299274279,315720857,333512219,333611970,333517061,333517064,333513665,333513662,333512219,333611970,334357175,333514124,333974197,333974200,333974164,333972886,317169401,317169101,317169104,315881629,315883102,299113320,299008277,299243536,333845658,333845661,333974197,333974200,333729869,333729872,333974164,333972886,280783524,335453432,241992493,242196987,224063281,241890188,254141473,316754573,241998244,229805586,243658881,315227666,320163566,315229370,315209658,315209649,314882338,315190776,315195378,315190779,315205469,315360490,315360487,315195375,315205466,320375557,320375560,306960549,312278613,315205394,315210806,315190470,269309104,315190701,315360562,315362545,315190752,272217475,272217475,322260906,316731180,316717049,295491829,315190749,321034528,326792568,327862644,339888752,339888770,340021914,339888761,340006020,340867441,340170508,340174306,340170544,340172041,326778558,326853353,340181785,340181818,339889046,339898976,340029410,340318301,340174291,340170541,297027005,288948342,288948357,288948339,288948354,291970551,291970548,291970545,291970542,291970539,298660362,298580117,298580312,298580342,288948336,288948351,293239917,293239938,293239929,293239923,293239935,293239920,293239944,293239932,293239926,293239941,291480310,288948333,288948348,288948330,288948345,279992129,298945896,299082016,298945011,298945893,298844939,298844930,299081986,299082508,298844942,299082007,298945899,299082010,299082004,299081983,298844927,299081980,321570784,321570061,321423396,321568363,321423390,321568360,321423939,321423933,321570781,321423393,315810434,315810431,298944990,298844924,299081977,299082487,298946175,299082139,299082001,298944999,315979669,315806511,298844915,299082127,299082502,298844921,298946181,299081995,299081992,298946172,331201983,331153586,331133072,331143770,331154798,331143800,331154291,331227135,331152677,331155194,331155113,331152587,331326763,331224594,331326778,331201965,332791593,332707400,332790114,332713616,331155809,331230849,331230453,331232319,337690161,337664874,337831555,337690191,337527356,337664862,337690185,337831561,337831519,337690173,337831546,337557107,337527389,337664877,337664883,337690194,337527365,337690179,337831552,337664892,337673820,337690176,337831549,337547300,333998505,334124077,333997707,333997710,337551371,337690419,337557359,337547483,337551374,337551377,337567661,337567673,337567664,337567670,337690416,337690425,337704003,337557362,337563299,337567691,298915449,298819160,299082073,298946103,299406979,299081959,299082070,299082454,299406982,298945866,299175368,299081923,299082421,299082049,299272104,298946109,299082448,299082052,298945869,299082445,298946127,298944948,299082451,298944204,299082058,302458981,302458984,299081920,299081926,298946112,298944930,299082055,298944183,330197105,330197165,299102536,315979666,315979663,298967727,299102533,315979960,315979519,298967091,315809837,315979948,315806508,307695667,308362233,308364228,308362224,328477487,328499136       
            )
        )
    SELECT
        conversions.user_id AS user_id,
        conversions.event_time AS conversion_time,
        conversions.cnv_id AS conversion_id,
        events.event_time AS event_time,
        events.event_type AS event_type,
        events.placement_id AS placement_id,
          CASE         
                WHEN placement_id IN(254411042,259702611,238331303,241818948,266044619,271292767,272401082,273597388,288423978,280206774,282287145,311361486,305471806,299061052,307709662,307482773,306522556,307705018,307482542,306317883,308922553,323469015,323469717,322016160,316224973,316244773,316060487,327578986) THEN 'Acq email-Amobee-Prospecting'
                WHEN placement_id IN(326369840) THEN 'Acq email-Zeta-Prospecting'
                WHEN placement_id IN(299072005,298833611,298935888,298936431,298935891,299071999,298935885) THEN 'Display-Causal IQ-Prospecting'
                WHEN placement_id IN(321452976,321411719,307529085,316471317,316470231,316471068,316470225,316350237,316468941,316468947,316471062,316482023,316470237,316471059,316553086,316470837,316470519,299074105,299074510,299074507,299074516,299074102,299074504,299074513,317481016,317277101,317276514,317481022,317480692,325620001,325620004,325620010,325620007,325620013,325620016,325620019,325423242,325384304,325617961,325618474,325618477,325617967,325617973,336042486,336203260,336042549,335919317,335918249,335918474,335919374,325385591,325385594,325385597,325385600,325385603,325385606,325385609,325384358,325384361,325384364,325384367,325384370,325384373,325384376,325620061,325620064,325620067,325620070,325620073,325620076,325620079,311272200,335225250,311272458,335225253,311272197,335225256,311272449,335225259,311421187,335225262,311272461,335225265,311272455,335225268,325385495,325385498,325385501,325385504,325385507,325385510,325385513,339547979,332657005,332657785,311421190,311272206,311272209,311272212,311421193,311421196,311272464,325617526,325617529,325617532,325617535,325617538,325617541,325622344,325620145,325620148,325620151,325620154,325620157,325620160,325620163,333086368,333090088,333086380,333091783,333091795,333092098,333007833,337797530,337938255,337797545,337783421,337797554,337938279,337946505,317627842,317627845,317417840,317627296,317627839,317422260,317627293,317423592,317425416,317627287,317627836,317423589,317425152,317425155,317627281,317627284,317417837,317627830,317423586,317423583,317627833,317417846,317425422,317422269,317425158,317425419,317425161,317627851) THEN 'Display-DV360-Prospecting'
                WHEN placement_id IN(325617901,325617907,325617910,325385456,325385450,325423239,325385453,316909111,316697885,316699226,316699229,316698725,316698449,316697618,325617403,325617406,325617409,325617412,325617415,325617418,325617421,316697888,316698731,316697894,316699421,316698734,316697891,316697900,311336242,311335972,311336245,311197095,311196723,311335762,311335975,311196705,311111327,311196702,311112119,311336224,311336227,311335741,311335960,311196714,311335750,311198619,311335753,311111333,311335963,311336221,311196699,311335732,311335735,311197083,311196696,311335738,311196708,311111330,311196711,311112158,311335747,311335744,311198583,311198754,311196726,311197098,311197101,311111348,311198742,311335765,311111336,311335969,311196717,311336233,311197089,311335756,311335966) THEN 'Display-DV360-Remarketing'
                WHEN placement_id IN(309499086,309673288,309501018,309497577,309670915,309500802,309401273,310149127,310149130,309918030) THEN 'Display-Google-VPN'
                WHEN placement_id IN(316126750,316126741,316126747,316126744,315949275,315951039,316125094,315949278,316125097,315951375,340862340,340869618,340713344,340866675,340990975,340866681,340869630,315807114,315808365,315980161,315980170,315980164,315807807,315808362) THEN 'Display-Matterkind-Prospecting'
                WHEN placement_id IN(299059237,298818551,298817564,298818545,299059231,299057224,299057836) THEN 'Display-Media IQ-Prospecting'
                WHEN placement_id IN(341005199,307435493,299057890,315796014,299042413,299057923,298915524,299057965,298915536,299057317,298915500,299059384,298913898,315789864,299056519,315789861,299056795,315965791,299056798,315789867,298818524,315789873,298914108) THEN 'Display-Media Math-Prospecting'
                WHEN placement_id IN(298817984,299057962,299059393,298915527) THEN 'Display-Media Math-Remarketing'
                WHEN placement_id IN(332429143) THEN 'Display-Trip Advisor-Prospecting'
                WHEN placement_id IN(307688617,307688620,323120018,316824442,318069449,318069446,316074839,316624094,316685492,316824439,315965170,315792851,315792857,316470219,315965164,315789693,315789876,315965797,315965779,315789855,315791834,315792854,316482014,315791825,315787902,315791849,315965776,315791828,315791822,315789705,315965167,315789870,315792164,315789879,316471026,315789696,315787914,315789852,315965788,315965782,315787905,315789690,315792161,330173174,330185934,330173183,330196569,330191166,330191526,330185943,339538184) THEN 'Display-Yahoo-Prospecting'
                WHEN placement_id IN(245606684,246423569) THEN 'Display-Yahoo-Remarketing'
                WHEN placement_id IN(341345693,341361809) THEN 'Display-Ziff Davis-Prospecting from Affiliate team'
                WHEN placement_id IN(341811987) THEN 'Display-iMedia Audiences-Prospecting'
                WHEN placement_id IN(301126951,301125868,301127413,316679467,316677544) THEN 'Email-Amobee-Prospecting'
                WHEN placement_id IN(334573477,334352834,334664501,334664504,334573474,334356959,334448268,334448274) THEN 'OTT-Google-Prospecting'
                WHEN placement_id IN(298993016,299235565,299230648,299007293) THEN 'OTT-Media Math-Prospecting'
                WHEN placement_id IN(315881638,299274279,315720857,333512219,333611970,333517061,333517064,333513665,333513662,333512219,333611970,334357175) THEN 'OTT-Roku-Prospecting'
                WHEN placement_id IN(333514124) THEN 'OTT-Roku-Remarketing'
                WHEN placement_id IN(333974197,333974200,333974164,333972886,317169401,317169101,317169104,315881629,315883102,299113320,299008277,299243536,333845658,333845661,333974197,333974200,333729869,333729872,333974164,333972886) THEN 'OTT-Yahoo-Prospecting'
                WHEN placement_id IN(280783524) THEN 'SEM-Ad Market-Prospecting'
                WHEN placement_id IN(335453432) THEN 'SEM-Ad.net-Prospecting'
                WHEN placement_id IN(241992493,242196987,224063281,241890188) THEN 'SEM-Bing-Prospecting'
                WHEN placement_id IN(254141473,316754573,241998244,229805586,243658881) THEN 'SEM-Google-Prospecting'
                WHEN placement_id IN(315227666,320163566,315229370,315209658,315209649,314882338,315190776,315195378,315190779,315205469,315360490,315360487,315195375,315205466,320375557,320375560,306960549,312278613,315205394,315210806,315190470,269309104,315190701,315360562,315362545,315190752,272217475,272217475,322260906,316731180,316717049,295491829,315190749,321034528,326792568,327862644,339888752,339888770,340021914,339888761,340006020,340867441,340170508,340174306,340170544,340172041,326778558,326853353) THEN 'Social-Facebook-Prospecting'
                WHEN placement_id IN(340181785,340181818,339889046,339898976,340029410,340318301) THEN 'Social-Facebook-Retargeting'
                WHEN placement_id IN(340174291) THEN 'Social-Pinterest-Prospecting'
                WHEN placement_id IN(340170541) THEN 'Social-Pinterest-Retargeting'
                WHEN placement_id IN(297027005,288948342,288948357,288948339,288948354,291970551,291970548,291970545,291970542,291970539,298660362,298580117,298580312,298580342,288948336,288948351,293239917,293239938,293239929,293239923,293239935,293239920,293239944,293239932,293239926,293239941,291480310,288948333,288948348,288948330,288948345) THEN 'Social-Reddit-Prospecting'
                WHEN placement_id IN(279992129) THEN 'TV-KTXS-Prospecting'
                WHEN placement_id IN(298945896,299082016,298945011,298945893,298844939,298844930,299081986,299082508,298844942,299082007,298945899,299082010,299082004,299081983,298844927,299081980,321570784,321570061,321423396,321568363,321423390,321568360,321423939,321423933,321570781,321423393,315810434,315810431,298944990,298844924,299081977,299082487,298946175,299082139,299082001,298944999,315979669,315806511,298844915,299082127,299082502,298844921,298946181,299081995,299081992,298946172,331201983,331153586,331133072,331143770,331154798,331143800,331154291,331227135,331152677,331155194,331155113,331152587,331326763,331224594,331326778,331201965,332791593,332707400,332790114,332713616,331155809,331230849,331230453,331232319,337690161,337664874,337831555,337690191,337527356,337664862,337690185,337831561,337831519,337690173,337831546,337557107,337527389,337664877,337664883,337690194,337527365,337690179,337831552,337664892,337673820,337690176,337831549,337547300,333998505,334124077,333997707,333997710) THEN 'Video-Google-Prospecting'
                WHEN placement_id IN(337551371,337690419,337557359,337547483,337551374,337551377,337567661,337567673,337567664,337567670,337690416,337690425,337704003,337557362,337563299,337567691) THEN 'Video-Google-Remarketing'
                WHEN placement_id IN(298915449,298819160) THEN 'Video-MIQ-Prospecting'
                WHEN placement_id IN(299082073,298946103,299406979,299081959,299082070,299082454,299406982,298945866,299175368,299081923,299082421,299082049,299272104,298946109,299082448,299082052,298945869,299082445,298946127,298944948,299082451,298944204,299082058,302458981,302458984,299081920,299081926,298946112,298944930,299082055,298944183) THEN 'Video-Media Math-Prospecting'
                WHEN placement_id IN(330197105,330197165,299102536,315979666,315979663,298967727,299102533,315979960,315979519,298967091,315809837,315979948,315806508,307695667,308362233,308364228,308362224) THEN 'Video-Yahoo-Prospecting'
                WHEN placement_id IN(328477487,328499136) THEN 'Video-Yahoo-Remarketing'
        ELSE '--'
        END AS tactic,
        # ROW_NUMBER() OVER (PARTITION BY conversions.user_id, conversions.cnv_id ORDER BY events.event_time DESC ) - 1 AS last_to_first_index,
        # ROW_NUMBER() OVER (PARTITION BY conversions.user_id, conversions.cnv_id ORDER BY events.event_time ) - 1 AS first_to_last_index,
        # CASE WHEN conv_flag = 1 THEN 1 ELSE 0 END as conv_flag,
        ROW_NUMBER() OVER(PARTITION BY conversions.user_id ORDER BY conversions.event_time DESC) AS touch_num,
    FROM conversions 
    JOIN events
    ON  conversions.user_id = events.user_id
    AND conversions.event_time - events.event_time BETWEEN 0 AND (@lookback_window * 8.64e10) 
  ),

conversions_and_paths_dedup AS(
    SELECT 
    user_id,
    conversion_time,
    STRING_AGG(DISTINCT tactic,'&&' ORDER BY tactic ASC) as distinct_touchpoints,
    --STRING_AGG(event_type, " ** " ORDER BY event_time asc) as interaction_path,
FROM path_to_conversion
--WHERE touch_num <= @max_touchs
GROUP BY user_id,conversion_time
)

SELECT
    distinct_touchpoints,
    COUNT(*) as total_paths,
FROM conversions_and_paths_dedup
GROUP BY 1--, 2
ORDER BY 2 DESC --3 DESC